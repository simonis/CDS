<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta charset="utf-8" />

    <title>Class Data Sharing - Sharing Economy in the HotSpot VM</title>

    <meta name="description" content="Class Data Sharing in the HotSpot VM" />
    <meta name="author" content="Volker H. Simonis" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />

    <link rel="stylesheet" href="reveal.js/css/reveal.css" />
    <link rel="stylesheet" href="reveal.js/css/theme/joker2017.css" id="theme" />
    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="reveal.js/lib/css/monokai_sublime.css" />
    <!-- Local overrides -->
    <link rel="stylesheet" href="css/local.css" />

    <style type="text/css">
    </style>

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="reveal.js/lib/js/html5shiv.js"></script>
    <![endif]-->

    <!--
      Issue #1105: Keyboard shortcut to skip forward/back over fragments #1173
      https://github.com/hakimel/reveal.js/pull/1173
    -->
  </head>

<!--
;; indent block of text
;; C-u <number> C-x <TAB>



;; select this code and do 'M-x eval-region'
(defun make-fragment (p1 p2)
  "Wraps the selection into 'fragment' <span>s and quotes '&', '<' and '>'."
  (interactive "r")
  (setq inputStr (buffer-substring-no-properties p1 p2))
  (setq inputStr (replace-regexp-in-string "&" "&amp;" inputStr))
  (setq inputStr (replace-regexp-in-string "<" "&lt;" inputStr))
  (setq inputStr (replace-regexp-in-string ">" "&gt;" inputStr))
  (setq resultStr (concat "<span class=\"fragment\">" (concat inputStr "</span>")))
  (delete-region p1 p2)
  (insert resultStr)
)
(defun make-fragment-simple (p1 p2)
  "Wraps the selection into 'fragment' <span>s without any quoting."
  (interactive "r")
  (setq inputStr (buffer-substring-no-properties p1 p2))
  (setq resultStr (concat "<span class=\"fragment\">" (concat inputStr "</span>")))
  (delete-region p1 p2)
  (insert resultStr)
)
(defun quote-fragment (p1 p2)
  "Quotes '&', '<' and '>'."
  (interactive "r")
  (setq inputStr (buffer-substring-no-properties p1 p2))
  (setq inputStr (replace-regexp-in-string "&" "&amp;" inputStr))
  (setq inputStr (replace-regexp-in-string "<" "&lt;" inputStr))
  (setq inputStr (replace-regexp-in-string ">" "&gt;" inputStr))
  (delete-region p1 p2)
  (insert inputStr)
)

(global-set-key (kbd "C-f") 'make-fragment)
(global-set-key (kbd "C-S-f") 'make-fragment-simple)
(global-set-key (kbd "C-S-q") 'quote-fragment)
;; revert key-binding
;; (global-set-key (kbd "C-f") 'forward-char)
;;
;; use 'C-h k <keystroke>' to find out what <keystroke> is currently bound to

;; (vhs) The following is required to make 'C-c C-t' insert <code> tags without
;; newlines. 'sgml-tag-alist' is the "file-local" version of 'html-tag-alist'
(add-to-list 'html-tag-alist '("code"))
(add-to-list 'sgml-tag-alist '("code"))

-->

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

        <section>
          <h1>Class Data Sharing</h1>
          <h3>Sharing Economy in the HotSpot VM</h3>
          <p>
            <small>Volker Simonis, SAP / <a href="mailto:volker.simonis@gmail.com">volker.simonis@gmail.com</a></small>
          </p>
        </section>

        <section>

          <h3 style="text-transform: none;"><a href="https://simonis.github.io/JBreak2018">https://simonis.github.io/JBreak2018</a></h3>

        </section>

        <section>

          <section>
            <h2>Containers and Microservices everywhere</h2>

            <ul>
              <li>Small footprint</li>
              <li>Fast startup</li>
            </ul>
          </section>

          <section>
            <h2>Class Data Sharing &amp; Ahead of Time Compilation</h2>

            <ul>
              <li>CDS: Cache preprocessed class metadata on disc</li>
              <li>AOT: Cache precompiled Java code on disc</li>
              <li>Improve startup performance</li>
              <li>Reduce memory footprint</li>
            </ul>
          </section>


          <section>
            <h2>Short History of CDS in the HotSpot VM</h2>

            <ul>
              <li class="fragment">Introduced 2004 with <a href="https://docs.oracle.com/javase/1.5.0/docs/guide/vm/class-data-sharing.html">JDK 1.5</a>
                <ul>
                  <li>Only for Client VM, only Serial GC</li>
                  <li>Only system classes</li>
                </ul>
              </li>
              <li class="fragment">Part of the initial OpenJDK 6/7 contribution</li>
              <li class="fragment">Since OpenJDK 9 / <a href="https://docs.oracle.com/javase/9/vm/class-data-sharing.htm#JSJVM-GUID-0260F857-A70E-4399-A1DF-A5766BE33285">JDK 9</a>:
                <ul>
                  <li>Support for Server VM</li>
                  <li>Support for G1, Serial, Parallel and ParallelOld GCs</li>
                  <li>Support for shared strings (only with G1, non-Windows)</li>
                  <li>Support for application classes
                    (<a href="https://docs.oracle.com/javase/9/tools/java.htm#JSWOR-GUID-31503FCE-93D0-4175-9B4F-F6A738B2F4C4">commercial Oracle JDK feature</a>)</li>
                </ul>
              </li>
              <li class="fragment">Coming with OpenJDK 10:
                <ul>
                  <li><a href="http://openjdk.java.net/jeps/31">JEP 310: Application Class-Data Sharing</a></li>
                </ul>
              </li>
            </ul>
          </section>

          <section>
            <h2>The Footprint/Performance Uncertainty Principle</h2>

          </section>
        </section>

        <section class="demo">

          <section class="demo">

            <h2>Class representation in the HotSpot VM</h2>

            <div width="100%" style="position: relative; margin: 0 0 0 0px;">
              <div class="" style="position: static; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_1.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="1" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_2.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="2" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_3.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="3" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_4.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="4" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_5.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="5" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_6.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="6" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_7.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="7" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_8.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="8" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_9.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="9" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_10.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="10" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_11.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="11" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_12.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="12" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_13.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="13" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_14.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>
              <div class="fragment" data-fragment-index="14" style="position: absolute; left: 0; top: 0; width: 100%">
                <object data="images/CodeCacheMetaspaceHeap_15.svg" type="image/svg+xml"
                        style="width: 90%;">&nbsp;</object>
              </div>

            </div>
          </section>

        </section>

        <section class="demo">

          <section class="demo">

            <h2>CDS Basics - Create the Archive</h2>

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%">
$ java -Xshare:dump<span class="fragment" data-fragment-index="0">
<span class="fragment highlight-current-border" data-fragment-index="1">Allocated shared space: 3221225472 bytes at 0x0000000800000000</span>
<span class="fragment highlight-current-border" data-fragment-index="2">Loading classes to share ...</span> <span class="fragment" data-fragment-index="2">// from <mark class="border">JAVA_HOME/lib/classlist</mark></span>
<span class="fragment highlight-current-border" data-fragment-index="3">Rewriting and linking classes ...</span> <span class="fragment" data-fragment-index="3"> // Verification, ...</span>
<span class="fragment highlight-current-border" data-fragment-index="4">Number of classes 1240</span>
<span class="fragment highlight-current-border" data-fragment-index="5">Removing unshareable information ... done.</span>
<span class="fragment highlight-current-border" data-fragment-index="6">Relocating embedded pointers ...</span>
<span class="fragment highlight-current-border border-no-bottom" data-fragment-index="7">Dumping symbol table ...                                </span>
<span class="fragment highlight-current-border border-no-top   " data-fragment-index="7">Dumping String objects to closed archive heap region ...</span>
<span class="fragment highlight-current-border" data-fragment-index="8">Removing java_mirror ... done.</span> <span class="fragment" data-fragment-index="8"> // java.lang.Class&lt;?&gt;</span>
mc  space:     21832 [  0,1% ] ... at 0x0000000800000000
<span class="fragment highlight-current-border" data-fragment-index="9">rw  space:   4093816 [ 22,2% ] ... at 0x0000000800006000</span>
<span class="fragment highlight-current-border" data-fragment-index="10">ro  space:   7313320 [ 39,7% ] ... at 0x00000008003ee000</span>
md  space:      6352 [  0,0% ] ... at 0x0000000800ae8000
od  space:   6462536 [ 35,1% ] ... at 0x0000000800aea000
<span class="fragment highlight-current-border border-no-bottom" data-fragment-index="11">st0 space:    458752 [  2,5% ] ... at 0x00000000fff00000</span>
<span class="fragment highlight-current-border border-no-top" data-fragment-index="11">oa0 space:     65536 [  0,4% ] ... at 0x00000000ffe00000</span>
total    :  <span class="fragment highlight-border" data-fragment-index="12">18422144</span> [100.0% ] <span class="fragment" data-fragment-index="12"> // <mark class="border">JAVA_HOME/lib/server/classes.jsa</mark></span></span>
              </code>
            </pre>

          </section>

        </section>

        <section class="demo">

          <section class="demo">

            <h2>CDS Basics - Using the Archive</h2>

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="java" data-trim="true" data-noescape="true" style="height:100%">
package io.simonis;

public class HelloCDS {
  public static void main(String[] args) throws IOException {
    System.out.println("Hello CDS");
    System.in.read();
  }
}
              </code>
            </pre>
          </section>

          <section class="demo">

            <h2>CDS Basics - Using the Archive</h2>

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
$ java <span class="fragment highlight-current-border">-Xshare:on</span> io.simonis.HelloCDS
<span class="fragment">HelloCDS
$ </span><span class="fragment">java -Xshare:on <span class="fragment highlight-current-border">-Xlog:class+load</span> io.simonis.HelloCDS
</span><span class="fragment">[class,load] java.lang.Object <span class="fragment highlight-current-border">source: shared objects file</span>
...</span>
<span class="fragment">[class,load] j.i.l.URLClassPath$FileLoader <span class="fragment highlight-current-border">source: jrt:/java.base</span>
...</span>
<span class="fragment">[class,load] io.simonis.HelloCDS2 source: <span class="fragment highlight-current-border">file:/examples/bin/</span>
HelloCDS</span>
<span class="fragment">$ java -Xshare:on -Xlog:class+load io.simonis.HelloCDS \
      | <span class="fragment highlight-current-border">grep "shared objects file"</span> | wc</span>
    <span class="fragment">477    2862   40977
$ </span><span class="fragment">java -Xshare:on -Xlog:class+load io.simonis.HelloCDS \
      | <span class="fragment highlight-current-border">grep -v "shared objects file"</span> | wc</span>
      <span class="fragment">5      17     424</span>
              </code>
            </pre>
          </section>

          <section class="demo">

            <h2>CDS Basics - Performance</h2>

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
$ time -f "%e sec\n" java <span class="fragment highlight-current-border">-Xshare:off</span> io.simonis.HelloCDS
<span class="fragment">Hello CDS
0.162 sec
$</span> <span class="fragment">time -f "%e sec\n" java <span class="fragment highlight-current-border">-Xshare:on</span>  io.simonis.HelloCDS          </span>
<span class="fragment">Hello CDS
0.148 sec</span>
              </code>
            </pre>

            <p class="fragment">About 9% overall performance improvement</p>

            <pre class="big noshadow fragment" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
$ java <span class="fragment highlight-current-border">-Xshare:off</span> <span class="fragment highlight-current-border">-Xlog:class+load</span> io.simonis.HelloCDS
<span class="fragment">[0,164s][class,load] io.simonis.HelloCDS source: file:/examples/bin
$</span> <span class="fragment">java <span class="fragment highlight-current-border">-Xshare:on</span>  -Xlog:class+load io.simonis.HelloCDS</span>
<span class="fragment">[0,143s][class,load] io.simonis.HelloCDS source: file:/examples/bin</span>
              </code>
            </pre>

            <p class="fragment">Application class loads about 13% faster</p>
          </section>

          <section class="demo">

            <h2>CDS Basics - Memory</h2>

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
$ java -Xshare:on io.simonis.HelloCDS &amp;
<span class="fragment" data-fragment-index="1">HelloCDS
$</span><span class="fragment" data-fragment-index="2"> pmap -X `pgrep -f HelloCDS`
</span><span class="fragment" data-fragment-index="3">5707:  /jdk/bin/java -Xshare:auto io.simonis.HelloCDS
       Address Perm    Size   Rss   Pss Mapping
      00400000 r-xp       8     8     8 /jdk/bin/java
      00601000 r--p       4     4     4 /jdk/bin/java
      00602000 rw-p       4     4     4 /jdk/bin/java
      009b8000 rw-p     132    28    28 [heap]
      <span class="fragment highlight-current-border" data-fragment-index="4">83200000 rw-p  129024  2048  2048</span> <span class="fragment" data-fragment-index="4">//   mapped Java heap</span>
      <span class="fragment highlight-current-border" data-fragment-index="5">8b000000 ---p 1914880     0     0</span> <span class="fragment" data-fragment-index="5">// unmapped Java heap</span>
      ffe00000 rw-p      64    64    64 /jdk/lib/server/classes.jsa
      fff00000 rw-p     448   448   448 /jdk/lib/server/classes.jsa
     800000000 rwxp      24    24    24 /jdk/lib/server/classes.jsa
     <span class="fragment highlight-current-border" data-fragment-index="6">800006000 rw-p    4000  3168  3168 /jdk/lib/server/classes.jsa</span>
     <span class="fragment highlight-current-border" data-fragment-index="7">8003ee000 r--p    7144  5160  5160 /jdk/lib/server/classes.jsa</span>
     800ae8000 rw-p       8     8     8 /jdk/lib/server/classes.jsa
     800aea000 r--p    6312     0     0 /jdk/lib/server/classes.jsa</span>
              </code>
            </pre>
          </section>

        </section>


        <section class="demo">

          <section class="demo">

            <h2>CDS &amp; AppCDS with <a href="https://tomcat.apache.org/download-90.cgi">Tomcat 9</a> &amp; <a href="http://naver.github.io/ngrinder/">nGrinder</a></h2>

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
$ CATALINA_OPTS="<span class="fragment highlight-current-border">-Xshare:on</span> \
                 <span class="fragment highlight-current-border">-Xlog:class+load:file=/tmp/tomcat.classtrace</span>" \
  catalina.sh start
$ <span class="fragment">wc /tmp/tomcat.classtrace</span>
  <span class="fragment"><span class="fragment highlight-border">12644</span>   50575 2075264 /tmp/tomcat.classtrace
$</span> <span class="fragment">grep "<span class="fragment highlight-current-border">shared objects file</span>" /tmp/tomcat.classtrace | wc</span>
   <span class="fragment"><span class="fragment highlight-border">1156</span>    6936  103052
$</span> <span class="fragment">CATALINA_OPTS="<span class="fragment highlight-current-border">-XX:DumpLoadedClassList=/tmp/tomcat.cls</span>" \
  catalina.sh start
$</span> <span class="fragment">wc /tmp/tomcat.cls</span>
   <span class="fragment"><span class="fragment highlight-border">3261</span>   3261 125647 /tmp/tomcat.cls
$</span> <span class="fragment">CATALINA_OPTS="-XX:DumpLoadedClassList=/tmp/tomcat_appcds.cls \
                 <span class="fragment highlight-current-border">-XX:+UseAppCDS</span>" \
  catalina.sh start
$</span> <span class="fragment">wc /tmp/tomcat_appcds.cls</span>
   <span class="fragment"><span class="fragment highlight-border">3520</span>   3520 133431 /tmp/tomcat_appcds.cls</span>
              </code>
            </pre>
          </section>

          <section class="demo">

            <h2>CDS &amp; AppCDS with <a href="https://tomcat.apache.org/download-90.cgi">Tomcat 9</a> &amp; <a href="http://naver.github.io/ngrinder/">nGrinder</a></h2>

            <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
              <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
$ CATALINA_OPTS="<span class="fragment highlight-current-border">-Xshare:dump -XX:+UseAppCDS</span> \
                 <span class="fragment highlight-current-border">-XX:SharedClassListFile=/tmp/tomcat_appcds.cls</span> \
                 -XX:+UnlockDiagnosticVMOptions \
                 <span class="fragment highlight-current-border">-XX:SharedArchiveFile=/tmp/tomcat_appcds.jsa</span>" \
  catalina.sh start
$<span class="fragment"> ll /tmp/tomcat_appcds.jsa</span>
<span class="fragment">-r--r----- <span class="fragment highlight-current-border">49.979.392</span> Feb  2 23:57 /tmp/tomcat_appcds.jsa
$</span> <span class="fragment">CATALINA_OPTS="<span class="fragment highlight-current-border">-Xshare:on -XX:+UseAppCDS</span> \
                 -XX:+UnlockDiagnosticVMOptions \
                 <span class="fragment highlight-current-border">-XX:SharedArchiveFile=/tmp/tomcat_appcds.jsa</span>" \
  catalina.sh start</span>
              </code>
            </pre>
          </section>

        </section>

        <section class="demo">

          <section class="demo">

            <h2>AppCDS - Application Class Data Sharing</h2>

            <ul>
              <li class="fragment">OpenJDK 10: <a href="http://openjdk.java.net/jeps/31">JEP 310 - Application Class-Data Sharing</a></li>
              <li class="fragment">Supports sharing of classes loaded by the application class loader <br/> (a.k.a. system class loader) with <code>-XX:+UseAppCDS</code></li>
              <li class="fragment"><em>Supports sharing of classes loaded by custom class loaders</em></li>
              <li class="fragment">Unfortunately <code>-XX:DumpLoadedClassList=.. -XX:+UseAppCDS</code> <br/> doesn't dump classes loaded by custom class loaders</li>
            </ul>
          </section>

          <section class="demo">

            <h2>AppCDS - Class List Format</h2>

            <ul>
              <li><code>-XX:DumpLoadedClassList=...</code> creates a trivial class list:<br/>

                <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
                  <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
$ cat /tmp/tomcat_appcds.cls
java/lang/Object
java/lang/String                                          
...
<span class="fragment highlight-current-border" data-fragment-index="1">org/apache/catalina/startup/Bootstrap</span>
                  </code>
                </pre>
              </li>
              <li class="fragment" data-fragment-index="2">The format for classes loaded by custom class loaders isn't specified<br/> anywhere, except in
                <a href="http://hg.openjdk.java.net/jdk/jdk/file/tip/src/hotspot/share/classfile/classListParser.cpp">classListParser.cpp</a><br/>

                <pre class="big noshadow fragment" data-fragment-index="3" style="height:100%; margin: 0;" data-trim="true">
                  <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
CLASSNAME [ ID ]?
CLASSNAME ID <span class="fragment highlight-current-border" data-fragment-index="5">super: ID</span> [ <span class="fragment highlight-current-border" data-fragment-index="5">interface: [ ID ]+</span> ]? <span class="fragment highlight-current-border" data-fragment-index="4">source: URL</span>
                  </code>
                </pre>
              </li>
            </ul>
          </section>

          <section class="demo">

            <h2>Creating a Class List for Custom Loaders</h2>

            <ul>
              <li><code>-Xlog:class+load<span class="fragment highlight-current-border" data-fragment-index="1">=debug</span></code> has all the information we need:<br/>

                <pre class="big noshadow fragment" data-fragment-index="2" style="height:100%; margin: 0;" data-trim="true">
                  <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
$ CATALINA_OPTS="-Xlog:class+load=debug" catalina.sh start
<span class="fragment" data-fragment-index="3">[info ] <span class="fragment highlight-current-border" data-fragment-index="4">java.lang.Object</span> <span class="fragment highlight-current-border" data-fragment-index="4">source: jrt:/java.base</span>
[debug]  klass: <span class="fragment highlight-current-border" data-fragment-index="9">0x100000eb0</span> super: 0x000000000 <span class="fragment highlight-current-border" data-fragment-index="5">loader: [NULL class loader]</span>
....
[info ] <span class="fragment highlight-current-border" data-fragment-index="6">java.sql.Timestamp</span> <span class="fragment highlight-current-border" data-fragment-index="6">source: jrt:/java.sql</span>
[debug]  klass: 0x100096c30 super: 0x100091a00 \
         <span class="fragment highlight-current-border" data-fragment-index="7">loader: [0xff0172600 a 'ClassLoaders$PlatformClassLoader']</span>
....
[info ] <span class="fragment highlight-current-border" data-fragment-index="8">org.apache.catalina.Server</span> <span class="fragment highlight-current-border" data-fragment-index="8">source: file:catalina.jar</span>
[debug]  klass: 0x1000e6410 <span class="fragment highlight-current-border" data-fragment-index="9">super: 0x100000eb0</span> <span class="fragment highlight-current-border" data-fragment-index="10">interfaces: 0x1000e6238</span> \
         <span class="fragment highlight-current-border" data-fragment-index="11">loader: [0xff0310fb0 a 'java/net/URLClassLoader']</span></span>
                  </code>
                </pre>
              </li>
              <li class="fragment" data-fragment-index="12">From this output we can easily create:<br/>

                <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
                  <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
<span class="fragment highlight-current-border" data-fragment-index="13">java/lang/Object</span>           <span class="fragment highlight-current-border" data-fragment-index="13">id: 0x100000eb0</span>
<span class="fragment highlight-current-border" data-fragment-index="14">java/sql/Timestamp </span>        <span class="fragment highlight-current-border" data-fragment-index="14">id: 0x100096c30</span>
<span class="fragment highlight-current-border" data-fragment-index="15">org/apache/catalina/Server</span> <span class="fragment highlight-current-border border-no-bottom" data-fragment-index="15">id: 0x1000e6410 super: 0x100000eb0 \        </span>
                           <span class="fragment highlight-current-border border-no-top   " data-fragment-index="15">interfaces: 0x1000e6238 source: catalina.jar</span>
                  </code>
                </pre>
              </li>
            </ul>
          </section>

          <section class="demo">

            <h2><code><a href="https://github.com/simonis/cl4cds">cl4cds</a></code></h2>

            <code>cl4cds</code> converts a class log into a CDS class list:

                <pre class="big noshadow" style="height:100%; margin: 0;" data-trim="true">
                  <code class="terminal" data-trim="true" data-noescape="true" style="height:100%;">
$ CATALINA_OPTS="<span class="fragment highlight-current-border">-Xlog:class+load=debug:file=tomcat_dbg.clstrace</span>" \
  catalina.sh start
$ <span class="fragment"><span class="fragment highlight-current-border">java io.simonis.cl4cds</span> <span class="fragment highlight-current-border">tomcat_dbg.clstrace</span> <span class="fragment highlight-current-border">tomcat_cl4cds.cls</span>
$</span><span class="fragment"> CATALINA_OPTS="<span class="fragment highlight-current-border">-Xshare:dump</span> -XX:+UseAppCDS \
                 <span class="fragment highlight-current-border">-XX:SharedClassListFile=tomcat_cl4cds.cls</span> \
                 -XX:+UnlockDiagnosticVMOptions \
                 <span class="fragment highlight-current-border">-XX:SharedArchiveFile=tomcat_cl4cds.jsa</span>" \
  catalina.sh start
$</span><span class="fragment"> ll tomcat_cl4cds.jsa</span>
<span class="fragment">-r--r----- 1 <span class="fragment highlight-border">102.305.792</span> Feb  3 01:48 tomcat_cl4cds.jsa
$</span><span class="fragment"> CATALINA_OPTS="<span class="fragment highlight-current-border">-Xshare:on</span> -XX:+UseAppCDS \
                 -XX:+UnlockDiagnosticVMOptions \
                 <span class="fragment highlight-current-border">-XX:SharedArchiveFile=tomcat_cl4cds.jsa</span> \
                 <span class="fragment highlight-current-border">-Xlog:class+load:file=tomcat_cl4cds.clstrace</span>" \
  catalina.sh start
$</span><span class="fragment"> wc tomcat_cl4cds.clstrace</span>
  <span class="fragment"><span class="fragment highlight-border">12644</span>   69335 1531203 tomcat_cl4cds.clstrace
$</span><span class="fragment"> grep "shared objects " tomcat_cl4cds.clstrace | wc</span>
   <span class="fragment"><span class="fragment highlight-border">9380</span>   56280  963418</span>
                  </code>
                </pre>
          </section>

<!--

Create HotSpot CDS archive in docker container:
===============================================
docker run -v /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples:/examples -p 8091:8080 -it - -rm -m 500m cds_demo_ojdk:latest /bin/bash

/examples/tomcat_measure.sh 1 "-XX:TieredStopAtLevel=1 -XX:CICompilerCount=1 -Xmx64m -Xms64m -Xlog:class+load=debug:file=/tmp/tomcat_dbg.clstrace"

java -cp /examples/cl4cds-1.0.0-SNAPSHOT.jar io.simonis.cl4cds /tmp/tomcat_dbg.clstrace /tmp/tomcat_cl4cds.cls

/examples/tomcat_measure.sh 1 "-XX:TieredStopAtLevel=1 -XX:CICompilerCount=1 -Xmx64m -Xms64m -XX:+UseG1GC -Xshare:dump -XX:+UseAppCDS -XX:SharedClassListFile=/tmp/tomcat_cl4cds.cls -XX:+UnlockDiagnosticVMOptions -XX:SharedArchiveFile=/tmp/tomcat_cl4cds.jsa"

Number of classes 9694
    instance classes   =  9602
    obj array classes  =    84
    type array classes =     8
Updating ConstMethods ... done. 
Removing unshareable information ... done. 
Scanning all metaspace objects ... 
Allocating RW objects ... 
Allocating RO objects ... 
Relocating embedded pointers ... 
Relocating external roots ... 
Dumping symbol table ...
Dumping String objects to closed archive heap region ...
Dumping objects to open archive heap region ...
Relocating SystemDictionary::_well_known_klasses[] ... 
Removing java_mirror ... done. 
mc  space:     13264 [  0.0% of total] out of     16384 bytes [ 81.0% used] at 0x0000000800000000
rw  space:  22873296 [ 22.1% of total] out of  22876160 bytes [100.0% used] at 0x0000000800004000
ro  space:  40262480 [ 38.9% of total] out of  40263680 bytes [100.0% used] at 0x00000008015d5000
md  space:      6160 [  0.0% of total] out of      8192 bytes [ 75.2% used] at 0x0000000803c3b000
od  space:  36699784 [ 35.4% of total] out of  36700160 bytes [100.0% used] at 0x0000000803c3d000
st0 space:    417792 [  0.4% of total] out of    417792 bytes [100.0% used] at 0x00000000ff400000
st1 space:   3145728 [  3.0% of total] out of   3145728 bytes [100.0% used] at 0x00000000ff500000
oa0 space:    176128 [  0.2% of total] out of    176128 bytes [100.0% used] at 0x00000000ff300000
total    : 103594632 [100.0% of total] out of 103604224 bytes [100.0% used]


Create OpenJ9 CDS archive in docker container:
==============================================
docker run -v /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples:/examples -p 8091:8080 -it - -rm -m 500m cds_demo_oj9:latest /bin/bash

/examples/tomcat_measure.sh 1 "-Xquickstart -Xmx64m -Xms64m -Xscmx128m -Xshareclasses:cacheDir=/tmp/tomcat_sa,name=tomcat,noaot,nojitdata,verbose -Xnoaot"

java -Xshareclasses:cacheDir=/tmp/tomcat_sa,name=tomcat,printStats

Current statistics for cache "tomcat": 

Cache created with:
	-Xnolinenumbers                      = false
	BCI Enabled                          = true
	Restrict Classpaths                  = false
	Feature                              = cr

Cache contains only classes with line numbers

base address                         = 0x00007FFFA4059000
end address                          = 0x00007FFFAC000000
allocation pointer                   = 0x00007FFFA5C1E7D8

cache size                           = 134217120
softmx bytes                         = 134217120
free bytes                           = 93735312
ROMClass bytes                       = 29120472
AOT bytes                            = 256
Reserved space for AOT bytes         = -1
Maximum space for AOT bytes          = -1
JIT data bytes                       = 0
Reserved space for JIT data bytes    = -1
Maximum space for JIT data bytes     = -1
Zip cache bytes                      = 0
Data bytes                           = 363936
Metadata bytes                       = 290200
Metadata % used                      = 0%
Class debug area size                = 10706944
Class debug area used bytes          = 5234970
Class debug area % used              = 48%

# ROMClasses                         = 11921
# AOT Methods                        = 0
# Classpaths                         = 5
# URLs                               = 0
# Tokens                             = 0
# Zip caches                         = 0
# Stale classes                      = 0
% Stale classes                      = 0%

Cache is 30% full


(1) docker run -v /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples:/examples -p 8091:8080 -i -x-rm -m 500m cds_demo_ojdk:latest /examples/tomcat_measure.sh 1 "-Xint -Xmx64m -Xms64m -Xshare:on -XX:+UseAppCDS -XX:+UnlockDiagnosticVMOptions -XX:SharedArchiveFile=/opt/tomcat_sa/tomcat_cl4cds.jsa"

(2) docker run -v /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples:/examples -p 8090:8080 -i -x-rm -m 500m cds_demo_ojdk:latest /examples/tomcat_measure.sh 1 "-Xint -Xmx64m -Xms64m -Xshare:on -XX:+UseAppCDS -XX:+UnlockDiagnosticVMOptions -XX:SharedArchiveFile=/opt/tomcat_sa/tomcat_cl4cds.jsa"

(3) docker run -v /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples:/examples -p 8080:8080 -i -x-rm -m 500m cds_demo_ojdk:latest /examples/tomcat_measure.sh 1 "-Xint -Xmx64m -Xms64m -Xshare:off -XX:+UseAppCDS -XX:+UnlockDiagnosticVMOptions -XX:SharedArchiveFile=/opt/tomcat_sa/tomcat_cl4cds.jsa"

CONTAINER           CPU %               MEM USAGE / LIMIT   MEM %               NET I/O             BLOCK I/O           PIDS
1c567fbd3e5f        2.23%               200.2MiB / 500MiB   40.03%              424kB / 6.54kB      45.1kB / 840kB      0      (3)
4dff19a42e28        6.19%               164.1MiB / 500MiB   32.81%              425kB / 6.43kB      86kB / 840kB        0      (2)
9bd6557f0d98        3.98%               164.9MiB / 500MiB   32.98%              425kB / 6.7kB       4.1kB / 836kB       0      (1)

CONTAINER           CPU %               MEM USAGE / LIMIT   MEM %               NET I/O             BLOCK I/O           PIDS
1c567fbd3e5f        5.26%               209.8MiB / 500MiB   41.95%              424kB / 6.54kB      45.1kB / 840kB      0
4dff19a42e28        2.98%               173.2MiB / 500MiB   34.63%              425kB / 6.43kB      86kB / 840kB        0
9bd6557f0d98        2.89%               173.9MiB / 500MiB   34.78%              425kB / 6.7kB       4.1kB / 836kB       0

OpenJ9
======
(1) docker run -v /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples:/examples -p 8091:8080 -i -x-rm -m 500m cds_demo_oj9:latest /examples/tomcat_measure.sh 1 "-Xmx64m -Xms64m -Xscmx128m -Xshareclasses:cacheDir=/opt/tomcat_sa,name=tomcat,noaot,nojitdata,verbose -Xint -Xnoaot -Xnojit"

(2) docker run -v /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples:/examples -p 8090:8080 -i -x-rm -m 500m cds_demo_oj9:latest /examples/tomcat_measure.sh 1 "-Xmx64m -Xms64m -Xscmx128m -Xshareclasses:cacheDir=/opt/tomcat_sa,name=tomcat,noaot,nojitdata,verbose -Xint -Xnoaot -Xnojit"

(3) docker run -v /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples:/examples -p 8080:8080 -i -x-rm -m 500m cds_demo_oj9:latest /examples/tomcat_measure.sh 1 "-Xmx64m -Xms64m -Xscmx128m -Xshareclasses:none -Xint -Xnoaot -Xnojit"

CONTAINER           CPU %               MEM USAGE / LIMIT   MEM %               NET I/O             BLOCK I/O           PIDS
6d2e95e90154        1.53%               150.9MiB / 500MiB   30.18%              425kB / 6.77kB      28.7kB / 840kB      0     (3)
1e595c6d8bb4        2.13%               124.5MiB / 500MiB   24.89%              423kB / 6.07kB      53.2kB / 840kB      0     (2)
7d01485605be        2.17%               124.6MiB / 500MiB   24.93%              424kB / 6.4kB       0B / 840kB          0     (1)

CONTAINER           CPU %               MEM USAGE / LIMIT   MEM %               NET I/O             BLOCK I/O           PIDS
6d2e95e90154        3.69%               155.6MiB / 500MiB   31.12%              425kB / 6.77kB      28.7kB / 840kB      0
1e595c6d8bb4        5.25%               129.3MiB / 500MiB   25.86%              424kB / 6.07kB      53.2kB / 840kB      0
7d01485605be        2.89%               129.2MiB / 500MiB   25.83%              424kB / 6.4kB       0B / 840kB          0


cat /sys/fs/cgroup/memory/docker/72ea9bf5ec4bb653ed42378099b2cdbef723f204d62222e3cb9705728d58702a/memory.stat

curl -x-unix-socket /var/run/docker.sock http://docker/containers/72ea9bf5ec4b/stats?stream=false

docker stats -x-no-stream
CONTAINER           CPU %               MEM USAGE / LIMIT   MEM %               NET I/O             BLOCK I/O           PIDS
72ea9bf5ec4b        0.94%               215.1MiB / 500MiB   43.01%              427kB / 6.92kB      868kB / 840kB       0

"-Xquickstart -Xmx64m -Xms64m -Xscmx128m -Xshareclasses:cacheDir=/tmp/xxx,name=tomcat,noaot,nojitdata,verbose -Xnoaot"

Create OpenJ9 jimage:
=====================
/share/software/Java/openJ9_jdk9-b181/bin/jlink -x-module-path /share/software/Java/openJ9_jdk9-b181/jmods -x-add-modules java.instrument,java.management,java.naming,java.security.jgss,java.sql,java.xml.ws -x-strip-debug -x-compress=2 -x-output /tmp/oj9
mv /tmp/oj9/lib/server /tmp/oj9/lib/j9vm
cp /share/software/Java/openJ9_jdk9-b181/lib/compressedrefs/lib* /tmp/oj9/lib/

simonis@simonis:/tmp$ JAVA_HOME=/share/software/Java/openJ9_jdk9-b181 /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples/tomcat_measure.sh 5 "-Xquickstart -Xmx64m -Xms64m"
19-Feb-2018 11:53:03.824 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16099 ms
                      2963224 212184 200569 KB 
19-Feb-2018 11:53:22.442 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16608 ms
                      2948560 199180 189485 KB 
19-Feb-2018 11:53:41.380 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16531 ms
                      2949080 196952 187257 KB 
19-Feb-2018 11:54:00.408 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16589 ms
                      2932440 196628 186933 KB 
19-Feb-2018 11:54:19.104 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16196 ms
                      2932700 196548 186853 KB 
simonis@simonis:/tmp$ JAVA_HOME=/share/software/Java/openJ9_jdk9-b181 /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples/tomcat_measure.sh 5 "-Xquickstart -Xmx64m -Xms64m"
19-Feb-2018 14:18:58.598 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16784 ms
                      2932176 196832 187094 KB 
19-Feb-2018 14:19:16.927 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16113 ms
                      2932696 196736 186998 KB 
19-Feb-2018 14:19:36.479 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16719 ms
                      2948564 200324 190586 KB 
19-Feb-2018 14:19:55.444 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16763 ms
                      2948564 203256 193628 KB 
19-Feb-2018 14:20:13.889 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16301 ms
                      2932700 196796 187168 KB 

simonis@simonis:/tmp$ JAVA_HOME=/share/software/Java/openJ9_jdk9-b181 /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples/tomcat_measure.sh 5 "-Xquickstart -Xmx64m -Xms64m -Xscmx256m -Xshareclasses:verbose -Xshareclasses:noaot -Xshareclasses:nojitdata"
19-Feb-2018 14:25:16.751 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 19371 ms
                      3225312 237000 227246 KB 
19-Feb-2018 14:25:33.059 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 14591 ms
                      3206636 225172 215418 KB 
19-Feb-2018 14:25:49.733 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 14296 ms
                      3223544 226944 217306 KB 
19-Feb-2018 14:26:06.749 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 14455 ms
                      3222764 237044 227286 KB 
19-Feb-2018 14:26:21.943 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 13592 ms
                      3206640 225888 216137 KB 
simonis@simonis:/tmp$ JAVA_HOME=/share/software/Java/openJ9_jdk9-b181 /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples/tomcat_measure.sh 5 "-Xquickstart -Xmx64m -Xms64m -Xscmx256m -Xshareclasses:verbose -Xshareclasses:noaot -Xshareclasses:nojitdata"
19-Feb-2018 14:26:49.003 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 13686 ms
                      3206636 226688 217050 KB 
19-Feb-2018 14:27:05.188 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 13702 ms
                      3206636 227920 218184 KB 
19-Feb-2018 14:27:21.027 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 13482 ms
                      3206636 230304 220691 KB 
19-Feb-2018 14:27:37.104 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 13646 ms
                      3206640 229184 219525 KB 
19-Feb-2018 14:27:53.062 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 13517 ms
                      3207160 231864 222213 KB 
simonis@simonis:/tmp$ JAVA_HOME=/share/software/Java/openJ9_jdk9-b181 /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples/tomcat_measure.sh 5 "-Xquickstart -Xmx64m -Xms64m -Xscmx256m -Xshareclasses:verbose -Xshareclasses:noaot -Xshareclasses:nojitdata"
19-Feb-2018 14:29:30.032 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 13798 ms
                      3206636 233044 223311 KB 
19-Feb-2018 14:29:46.330 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 13784 ms
                      3223020 243312 233674 KB 
19-Feb-2018 14:30:02.132 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 13606 ms
                      3223020 244496 234837 KB 
19-Feb-2018 14:30:17.984 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 13362 ms
                      3207160 237320 227555 KB 
19-Feb-2018 14:30:34.549 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 14034 ms
                      3222764 239712 229968 KB 

simonis@simonis:/tmp$ JAVA_HOME=/share/software/Java/openJ9_jdk9-b181 /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples/tomcat_measure.sh 5 "-Xquickstart -Xmx64m -Xms64m -Xscmx256m -Xshareclasses:verbose -Xshareclasses:noaot -Xshareclasses:nojitdata -Xnoaot"
19-Feb-2018 14:36:24.340 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16621 ms
                      3203052 231264 221643 KB 
19-Feb-2018 14:36:43.364 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16409 ms
                      3219436 241256 231635 KB 
19-Feb-2018 14:37:02.522 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16651 ms
                      3219436 232380 222759 KB 
19-Feb-2018 14:37:21.444 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16566 ms
                      3219436 233212 223591 KB 
19-Feb-2018 14:37:40.325 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16518 ms
                      3234360 235804 224252 KB 
simonis@simonis:/tmp$ JAVA_HOME=/share/software/Java/openJ9_jdk9-b181 /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples/tomcat_measure.sh 5 "-Xquickstart -Xmx64m -Xms64m -Xscmx256m -Xshareclasses:verbose -Xshareclasses:noaot -Xshareclasses:nojitdata -Xnoaot"
19-Feb-2018 14:38:12.367 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16644 ms
                      3219436 236060 226447 KB 
19-Feb-2018 14:38:31.562 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16726 ms
                      3218916 241380 231759 KB 
19-Feb-2018 14:38:50.429 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16718 ms
                      3202532 235012 225399 KB 
19-Feb-2018 14:39:09.394 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16766 ms
                      3217456 237232 225680 KB 
19-Feb-2018 14:39:28.338 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 16745 ms
                      3204076 238464 228843 KB 

Skipping java.lang.invoke.BoundMethodHandle$Species_LII from __JVM_DefineClass__ - reason: dynamically generated class
Skipping jdk.internal.reflect.GeneratedMethodAccessor1 from __JVM_DefineClass__ - reason: dynamically generated class
Skipping com.sun.proxy.$Proxy0 from __JVM_DefineClass__ - reason: dynamically generated class

Skipping org.slf4j.Logger from /share/software/Java/apache-tomcat-9.0.2/webapps/ngrinder-controller-3.4.1/WEB-INF/lib/slf4j-api-1.6.4.jar - reason: class is pre 1.5

Skipping org.ngrinder.infra.spring.Redirect404DispatcherServlet from /share/software/Java/apache-tomcat-9.0.2/webapps/ngrinder-controller-3.4.1/WEB-INF/classes/ - reason: loaded from class file (try '-Dio.simonis.cl4cds.dumpFromClassFile=true')

Skipping org.slf4j.impl.StaticLoggerBinder from /share/software/Java/apache-tomcat-9.0.2/webapps/ngrinder-controller-3.4.1/WEB-INF/lib/logback-classic-1.0.0.jar - reason: failed dependencies

$ /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples/tomcat_measure.sh 5
16-Feb-2018 14:38:34.851 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 18840 ms
                      5989256 572544 563985 KB 
16-Feb-2018 14:39:16.051 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 19467 ms
                      6002124 599876 589484 KB 
16-Feb-2018 14:39:55.655 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 18411 ms
                      5989256 600472 592014 KB 
16-Feb-2018 14:40:35.948 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 18142 ms
                      5991312 622492 613929 KB 
16-Feb-2018 14:41:17.925 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 19419 ms
                      5985144 665980 657421 KB 
16-Feb-2018 14:43:02.200 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 18407 ms
                      5990280 627868 619305 KB 
16-Feb-2018 14:43:43.513 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 19007 ms
                      5988228 625600 617037 KB 
16-Feb-2018 14:44:24.130 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 19071 ms
                      5989256 636224 627665 KB 
16-Feb-2018 14:45:04.853 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 19093 ms
                      6004180 676396 666004 KB 
16-Feb-2018 14:45:44.603 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 18317 ms
                      6006236 560472 550080 KB 

$ /c/Users/D046063/public_html/hotspot/JBreak2018/git/CDS/examples/tomcat_measure.sh 5 "-Xshare:on -XX:+UseAppCDS -XX:+UnlockDiagnosticVMOptions -XX:SharedArchiveFile=/tmp/tomcat_cl4cds.jsa"
16-Feb-2018 14:50:45.985 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 17953 ms
                      6043244 623932 615501 KB 
16-Feb-2018 14:51:26.752 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 18501 ms
                      6044272 658360 649929 KB 
16-Feb-2018 14:52:06.598 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 17723 ms
                      6045300 573684 565253 KB 
16-Feb-2018 14:52:46.966 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 17462 ms
                      6045300 619712 611281 KB 
16-Feb-2018 14:53:27.908 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 17738 ms
                      6044272 628384 619953 KB 


pmap - - read-rc-from=/c/Users/D046063/public_html/hotspot/FOSDEM2018/git/examples/pmap_slides.rc `pgrep -f tomcat`| less


CATALINA_OPTS="-Djava.security.edg=file:/dev/./urandom" $CATALINA_HOME/bin/catalina.sh start

16-Feb-2018 11:04:09.878 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 19368 ms
16-Feb-2018 11:09:11.988 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 19600 ms

         Address Perm    Size    Rss    Pss Mapping
                      5996964 642776 638454 KB
                      5989768 578628 574310 KB 

-->

        </section>

        <section>

          <h2>AppCDS - Current Limitations</h2>

          <ul>
            <li>Can't share pre 1.5 classes</li>
            <li>Can't share dynamically generated classes</li>
            <li>Can't share classes loaded from files (only .jar archives)</li>
            <li>Can't share classes modified by the class loader</li>
            <li>Can share only one class if loaded by several class loaders</li>
            <li>No bytecode-rewriting (slow interpreter)</li>
          </ul>
        </section>

        <section>

          <h2><a href="https://bugs.openjdk.java.net/browse/JDK-8194759">8194759: Support caching class mirror objects</a></h2>

          <ul>
            <li>Currently under review for Java 11</li>
          </ul>
        </section>

        <section>

          <h2>Class Data Sharing in OpenJ9</h2>

        </section>


        <section>

          <h3 style="text-transform: none;"><a href="https://simonis.github.io/JBreak2018">https://simonis.github.io/JBreak2018</a></h3>

        </section>

<!--

AppCds - Ceavets

- can't share pre 1.5 classes
- can't share dynamically generated classes
- can't share classes loaded from files (only .jar archives)
- can share only one class if loaded by several class loaders
- can't share classes modified by the class loader

- no bytecode-rewriting (slow interpreter)

$ CATALINA_OPTS="-Xshare:on -Xlog:class+load:file=/tmp/tomcat.classtrace" $CATALINA_HOME/bin/catalina.sh start
$ wc /tmp/tomcat.classtrace
  12644   50575 2075264 /tmp/tomcat.classtrace
$ grep "shared objects file" /tmp/tomcat.classtrace | wc
   1156    6936  103052
$ CATALINA_OPTS="-XX:DumpLoadedClassList=/tmp/tomcat.cls" $CATALINA_HOME/bin/catalina.sh start
$ wc /tmp/tomcat.cls
  3261   3261 125647 /tmp/tomcat.cls
$ CATALINA_OPTS="-XX:DumpLoadedClassList=/tmp/tomcat_appcds.cls -XX:+UseAppCDS" $CATALINA_HOME/bin/catalina.sh start
$ wc /tmp/tomcat_appcds.cls
  3520   3520 133431 /tmp/tomcat_appcds.cls

$ CATALINA_OPTS="-Xlog:class+load=debug:file=/tmp/tomcat_debug.classtrace" $CATALINA_HOME/bin/catalina.sh start

[0.009s][info ][class,load] java.lang.Object source: jrt:/java.base
[0.009s][debug][class,load]  klass: 0x0000000100000eb0 super: 0x0000000000000000 loader: [NULL class loader] bytes: 1932 checksum: b0107909
...
[0,213s][info ][class,load] java.sql.Timestamp source: jrt:/java.sql
[0,213s][debug][class,load]  klass: 0x0000000100096c30 super: 0x0000000100091a00 loader: [class loader 0x00007ffff0172600 a 'jdk/internal/loader/ClassLoaders$PlatformClassLoader'{0x000000008af9f628}] bytes: 6804 checksum: 27
...
[0,492s][info ][class,load] org.apache.catalina.Server source: file:/share/software/Java/apache-tomcat-9.0.2/lib/catalina.jar
[0,492s][debug][class,load]  klass: 0x00000001000e6410 super: 0x0000000100000eb0 interfaces: 0x00000001000e6238 loader: [class loader 0x00007ffff0310fb0 a 'java/net/URLClassLoader'{0x000000008aabf5b0}] bytes: 1244 checksum: 

org/apache/catalina/Lifecycle id: 0x00000001000e6238 super: 0x0000000100000eb0 source: catalina.jar
org/apache/catalina/Server id: 0x00000001000e6410 super: 0x0000000100000eb0 interfaces: 0x00000001000e6238 source: catalina.jar

$ CATALINA_OPTS="-Xshare:dump -XX:+UseAppCDS -XX:SharedClassListFile=/tmp/tomcat_cl4cds.cls -XX:+UnlockDiagnosticVMOptions -XX:SharedArchiveFile=/tmp/tomcat_cl4cds.jsa" $CATALINA_HOME/bin/catalina.sh start

$ CATALINA_OPTS="-Xshare:on -XX:+UseAppCDS -XX:+UnlockDiagnosticVMOptions -XX:SharedArchiveFile=/tmp/tomcat_cl4cds.jsa -Xlog:class+load:file=/tmp/tomcat_cl4cds.classtrace" $CATALINA_HOME/bin/catalina.sh start
$ wc /tmp/tomcat_cl4cds.classtrace
  12644   69335 1531203 /tmp/tomcat_cl4cds.classtrace
$ grep "shared objects " /tmp/tomcat_cl4cds.classtrace | wc
   9380   56280  963418


ConstantPool::archive_resolved_references(Thread *) : void - /jdk-hs/share/oops/constantPool.cpp
  MetaspaceShared::archive_resolved_constants(Thread *) : void - /jdk-hs/share/memory/metaspaceShared.cpp
    MetaspaceShared::dump_open_archive_heap_objects(GrowableArray<MemRegion> *) : void - /jdk-hs/share/memory/metaspaceShared.cpp
      VM_PopulateDumpSharedSpace::dump_java_heap_objects() : void - /jdk-hs/share/memory/metaspaceShared.cpp
        VM_PopulateDumpSharedSpace::doit() : void - /jdk-hs/share/memory/metaspaceShared.cpp


G1CollectedHeap::alloc_archive_regions(MemRegion *, size_t, bool) : bool - /jdk-hs/share/gc/g1/g1CollectedHeap.cpp
  FileMapInfo::map_heap_data(MemRegion * *, int, int, int *, bool) : bool - /jdk-hs/share/memory/filemap.cpp
    FileMapInfo::map_heap_regions() : void - /jdk-hs/share/memory/filemap.cpp (2 matches)
      MetaspaceShared::initialize_runtime_shared_and_meta_spaces() : void - /jdk-hs/share/memory/metaspaceShared.cpp
        Metaspace::global_initialize() : void - /jdk-hs/share/memory/metaspace.cpp
          universe_init() : jint - /jdk-hs/share/memory/universe.cpp


$ ls -la /share/output-jdk-hs-dbg/images/jdk/lib/server/classes.jsa
 1 simonis simonis 18436096 Feb  2 11:28 /share/output-jdk-hs-dbg/images/jdk/lib/server/classes.jsa

arguments.cpp
=============
#if COMPILER2_OR_JVMCI
  // Shared spaces work fine with other GCs but causes bytecode rewriting
  // to be disabled, which hurts interpreter performance and decreases
  // server performance.  When -server is specified, keep the default off
  // unless it is asked for.  Future work: either add bytecode rewriting
  // at link time, or rewrite bytecodes in non-shared methods.
  if (is_server_compilation_mode_vm() && !DumpSharedSpaces && !RequireSharedSpaces &&
      (FLAG_IS_DEFAULT(UseSharedSpaces) || !UseSharedSpaces)) {
    no_shared_spaces("COMPILER2 default: -Xshare:auto | off, have to manually setup to on.");
  }
#endif

// Null out class_loader_data because we don't share that yet.
set_class_loader_data(NULL);
Klass::remove_unshareable_info() : void - /jdk-hs/share/oops/klass.cpp
  InstanceKlass::remove_unshareable_info() : void - /jdk-hs/share/oops/instanceKlass.cpp (2 matches)
    InstanceKlass::remove_unshareable_info() : void - /jdk-hs/share/oops/instanceKlass.cpp
    remove_unshareable_in_classes() : void - /jdk-hs/share/memory/metaspaceShared.cpp
      VM_PopulateDumpSharedSpace::doit() : void - /jdk-hs/share/memory/metaspaceShared.cpp

Creating and using archive ONLY with same configuration (i.e. CompressedOops mode)

-XX:SharedBaseAddress=0x900000000

rewrite_nofast_bytecode(Method *) : void - /jdk-hs/share/memory/metaspaceShared.cpp
  rewrite_nofast_bytecodes_and_calculate_fingerprints() : void - /jdk-hs/share/memory/metaspaceShared.cpp
    VM_PopulateDumpSharedSpace::doit() : void - /jdk-hs/share/memory/metaspaceShared.cpp
      VM_Operation::evaluate() : void - /jdk-hs/share/runtime/vm_operations.cpp

#0  ClassListParser::load_current_class (this=0x7ffff7fd7960, __the_thread__=0x7ffff001a6f0) at /share/OpenJDK/jdk-hs/src/hotspot/share/classfile/classListParser.cpp:323
#1  0x00007ffff5a89f98 in ClassLoaderExt::load_one_class (parser=0x7ffff7fd7960, __the_thread__=0x7ffff001a6f0) at /share/OpenJDK/jdk-hs/src/hotspot/share/classfile/classLoaderExt.cpp:350
#2  0x00007ffff624699a in MetaspaceShared::preload_classes (class_list_path=0x7ffff000fa70 "TwoLoaders_a.cls", __the_thread__=0x7ffff001a6f0) at /share/OpenJDK/jdk-hs/src/hotspot/share/memory/metaspaceShared.cpp:1615
#3  0x00007ffff62467a6 in MetaspaceShared::preload_and_dump (__the_thread__=0x7ffff001a6f0) at /share/OpenJDK/jdk-hs/src/hotspot/share/memory/metaspaceShared.cpp:1584
#4  0x00007ffff651e8a4 in Threads::create_vm (args=0x7ffff7fd9e20, canTryAgain=0x7ffff7fd9d0b) at /share/OpenJDK/jdk-hs/src/hotspot/share/runtime/thread.cpp:3990
#5  0x00007ffff5f3283c in JNI_CreateJavaVM_inner (vm=0x7ffff7fd9e88, penv=0x7ffff7fd9e90, args=0x7ffff7fd9e20) at /share/OpenJDK/jdk-hs/src/hotspot/share/prims/jni.cpp:3908
#6  0x00007ffff5f32bdd in JNI_CreateJavaVM (vm=0x7ffff7fd9e88, penv=0x7ffff7fd9e90, args=0x7ffff7fd9e20) at /share/OpenJDK/jdk-hs/src/hotspot/share/prims/jni.cpp:4003
#7  0x00007ffff7bcd39a in InitializeJVM (pvm=0x7ffff7fd9e88, penv=0x7ffff7fd9e90, ifn=0x7ffff7fd9ee0) at /share/OpenJDK/jdk-hs/src/java.base/share/native/libjli/java.c:1478
#8  0x00007ffff7bca0e2 in JavaMain (_args=0x7fffffffa9f0) at /share/OpenJDK/jdk-hs/src/java.base/share/native/libjli/java.c:411
#9  0x00007ffff71ca184 in start_thread () from /lib/x86_64-linux-gnu/libpthread.so.0
#10 0x00007ffff78faffd in clone () from /lib/x86_64-linux-gnu/libc.so.6

For all entries without 'source:' tag call "java_system_loader().loadClass()"

For all other entries (with 'source:' tag) call ClassListParser::load_class_from_source(Symbol* class_name, TRAPS)

Use the following command to dump a shared archive:

/share/output-jdk-hs-dbg/images/jdk/bin/java -XX:+UnlockDiagnosticVMOptions -XX:SharedArchiveFile=/tmp/TwoLoaders_a.jsa -XX:+PrintSharedArchiveAndExit -XX:+PrintSharedDictionary -cp simonis.jar io.simonis.TwoLoaders

java_lang_Class::set_klass(oop, Klass *) : void - /jdk-hs/share/classfile/javaClasses.cpp
  InstanceKlass::deallocate_contents(ClassLoaderData *) : void - /jdk-hs/share/oops/instanceKlass.cpp
  java_lang_Class::create_mirror(Klass *, Handle, Handle, Handle, Thread *) : void - /jdk-hs/share/classfile/javaClasses.cpp (2 matches)
    ArrayKlass::complete_create_array_klass(ArrayKlass *, Klass *, ModuleEntry *, Thread *) : void - /jdk-hs/share/oops/arrayKlass.cpp
    ClassFileParser::fill_instance_klass(InstanceKlass *, bool, Thread *) : void - /jdk-hs/share/classfile/classFileParser.cpp
      ClassFileParser::create_instance_klass(bool, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/classFileParser.cpp
        KlassFactory::check_shared_class_file_load_hook(InstanceKlass *, Symbol *, Handle, Handle, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/klassFactory.cpp
          SystemDictionary::load_shared_class(InstanceKlass *, Handle, Handle, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionary.cpp
        KlassFactory::create_from_stream(ClassFileStream *, Symbol *, ClassLoaderData *, Handle, const InstanceKlass *, GrowableArray<Handle> *, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/klassFactory.cpp (2 matches)
          ClassLoader::load_class(Symbol *, bool, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/classLoader.cpp
          ClassLoaderExt::load_class(Symbol *, const char *, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/classLoaderExt.cpp
          SystemDictionary::parse_stream(Symbol *, Handle, Handle, ClassFileStream *, const InstanceKlass *, GrowableArray<Handle> *, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionary.cpp
          SystemDictionary::resolve_from_stream(Symbol *, Handle, Handle, ClassFileStream *, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionary.cpp
    java_lang_Class::fixup_mirror(Klass *, Thread *) : void - /jdk-hs/share/classfile/javaClasses.cpp
    Klass::restore_unshareable_info(ClassLoaderData *, Handle, Thread *) : void - /jdk-hs/share/oops/klass.cpp
      ArrayKlass::restore_unshareable_info(ClassLoaderData *, Handle, Thread *) : void - /jdk-hs/share/oops/arrayKlass.cpp
      initialize_basic_type_klass(Klass *, Thread *) : void - /jdk-hs/share/memory/universe.cpp
      InstanceKlass::restore_unshareable_info(ClassLoaderData *, Handle, Thread *) : void - /jdk-hs/share/oops/instanceKlass.cpp (2 matches)
        initialize_basic_type_klass(Klass *, Thread *) : void - /jdk-hs/share/memory/universe.cpp
        InstanceKlass::restore_unshareable_info(ClassLoaderData *, Handle, Thread *) : void - /jdk-hs/share/oops/instanceKlass.cpp
        SystemDictionary::load_shared_class(InstanceKlass *, Handle, Handle, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionary.cpp
          SystemDictionary::load_shared_class(Symbol *, Handle, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionary.cpp
          SystemDictionaryShared::acquire_class_for_current_thread(InstanceKlass *, Handle, Handle, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionaryShared.cpp
          SystemDictionaryShared::load_shared_class_for_builtin_loader(Symbol *, Handle, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionaryShared.cpp
            SystemDictionaryShared::find_or_load_shared_class(Symbol *, Handle, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionaryShared.cpp


// There can be only 1 class with this name for unregistered loaders.
SharedDictionary::get_entry_for_unregistered_loader(const Symbol *, int, int) : SharedDictionaryEntry * - /jdk-hs/share/classfile/systemDictionaryShared.cpp
  SharedDictionary::class_exists_for_unregistered_loader(const Symbol *) : bool - /jdk-hs/share/classfile/systemDictionaryShared.hpp
    SystemDictionaryShared::lookup_from_stream(const Symbol *, Handle, Handle, const ClassFileStream *, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionaryShared.cpp
  SharedDictionary::find_class_for_unregistered_loader(const Symbol *, int, int) : Klass * - /jdk-hs/share/classfile/systemDictionaryShared.cpp
    SystemDictionaryShared::lookup_from_stream(const Symbol *, Handle, Handle, const ClassFileStream *, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionaryShared.cpp
      SystemDictionary::resolve_from_stream(Symbol *, Handle, Handle, ClassFileStream *, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionary.cpp
        jni_DefineClass(JNIEnv *, const char *, jobject, const jbyte *, jsize) : jclass - /jdk-hs/share/prims/jni.cpp
          {init jni_NativeInterface}() : JNINativeInterface_ - /jdk-hs/share/prims/jni.cpp
        jvm_define_class_common(JNIEnv *, const char *, jobject, const jbyte *, jsize, jobject, const char *, Thread *) : jclass - /jdk-hs/share/prims/jvm.cpp
          JVM_DefineClass(JNIEnv *, const char *, jobject, const jbyte *, jsize, jobject) : jclass - /jdk-hs/share/prims/jvm.cpp
            Unsafe_DefineClass_impl(JNIEnv *, jstring, jbyteArray, int, int, jobject, jobject) : jclass - /jdk-hs/share/prims/unsafe.cpp
              Unsafe_DefineClass0(JNIEnv *, jobject, jstring, jbyteArray, int, int, jobject, jobject) : jclass - /jdk-hs/share/prims/unsafe.cpp
                {init jdk_internal_misc_Unsafe_methods}() : JNINativeMethod [71] - /jdk-hs/share/prims/unsafe.cpp
          JVM_DefineClassWithSource(JNIEnv *, const char *, jobject, const jbyte *, jsize, jobject, const char *) : jclass - /jdk-hs/share/prims/jvm.cpp


Dictionary::add_entry(int, DictionaryEntry *) : void - /jdk-hs/share/classfile/dictionary.hpp
  CombineDictionariesClosure::do_cld(ClassLoaderData *) : void - /jdk-hs/share/classfile/systemDictionary.cpp
  Dictionary::add_klass(unsigned int, Symbol *, InstanceKlass *) : void - /jdk-hs/share/classfile/dictionary.cpp
    SystemDictionary::update_dictionary(unsigned int, int, unsigned int, InstanceKlass *, Handle, Thread *) : void - /jdk-hs/share/classfile/systemDictionary.cpp
  SharedDictionary::add_non_builtin_klass(const Symbol *, ClassLoaderData *, InstanceKlass *) : bool - /jdk-hs/share/classfile/systemDictionaryShared.cpp
    SystemDictionaryShared::add_non_builtin_klass(Symbol *, ClassLoaderData *, InstanceKlass *, Thread *) : bool - /jdk-hs/share/classfile/systemDictionaryShared.cpp
      // if (!SystemDictionaryShared::add_non_builtin_klass(class_name, ClassLoaderData::the_null_class_loader_data(),...)
      // This adds the loaded class to the boot_loader_dictionary with a class loader set to the null (boot) class loader (altough the class was loaded by a custom class loader!!!)
      ClassListParser::load_class_from_source(Symbol *, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/classListParser.cpp
        ClassListParser::load_current_class(Thread *) : Klass * - /jdk-hs/share/classfile/classListParser.cpp
          ClassLoaderExt::load_one_class(ClassListParser *, Thread *) : Klass * - /jdk-hs/share/classfile/classLoaderExt.cpp
            MetaspaceShared::preload_classes(const char *, Thread *) : int - /jdk-hs/share/memory/metaspaceShared.cpp
              MetaspaceShared::preload_and_dump(Thread *) : void - /jdk-hs/share/memory/metaspaceShared.cpp (2 matches)


At runtime:

SystemDictionaryShared::acquire_class_for_current_thread(InstanceKlass *, Handle, Handle, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionaryShared.cpp
    if (ik->class_loader_data() != NULL) {
      //    ik is already loaded (by this loader or by a different loader)
      // or ik is being loaded by a different thread (by this loader or by a different loader)
      return NULL;
    }
SharedDictionary::find_class_for_unregistered_loader(const Symbol *, int, int) : Klass * - /jdk-hs/share/classfile/systemDictionaryShared.cpp
  SystemDictionaryShared::lookup_from_stream(const Symbol *, Handle, Handle, const ClassFileStream *, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionaryShared.cpp
    SystemDictionary::resolve_from_stream(Symbol *, Handle, Handle, ClassFileStream *, Thread *) : InstanceKlass * - /jdk-hs/share/classfile/systemDictionary.cpp
      jni_DefineClass(JNIEnv *, const char *, jobject, const jbyte *, jsize) : jclass - /jdk-hs/share/prims/jni.cpp
      jvm_define_class_common(JNIEnv *, const char *, jobject, const jbyte *, jsize, jobject, const char *, Thread *) : jclass - /jdk-hs/share/prims/jvm.cpp
        JVM_DefineClass(JNIEnv *, const char *, jobject, const jbyte *, jsize, jobject) : jclass - /jdk-hs/share/prims/jvm.cpp
        JVM_DefineClassWithSource(JNIEnv *, const char *, jobject, const jbyte *, jsize, jobject, const char *) : jclass - /jdk-hs/share/prims/jvm.cpp


TODO:

InstanceKlass* ClassListParser::load_class_from_source(Symbol* class_name, TRAPS) {

We shoould probably check for other 'prohibited packages' as well (and before we load the klass!):

  InstanceKlass* k = ClassLoaderExt::load_class(class_name, _source, THREAD);

  if (strncmp(_class_name, "java/", 5) == 0) {
    log_info(cds)("Prohibited package for non-bootstrap classes: %s.class from %s",
          _class_name, _source);
    return NULL;
  }

-->

      </div>
    </div>

    <script src="reveal.js/lib/js/head.min.js"></script>
    <script src="reveal.js/js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        //width: 1024,
        //height: 768,
        //width: 1280,
        //height: 720,
        width: 1366,
        height: 768,
        //width: 1920,
        //height: 1080,
        //margin: 0.1, // Old setting which was used in the reveal.js version used for the JET2015 presentation
        controls: true,
        progress: true,
        history: true,
        center: true,
        slideNumber: true,

        transition: 'none', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'reveal.js/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() {

hljs.registerLanguage('terminal', function(hljs) {
  return {
    contains: [
      hljs.C_LINE_COMMENT_MODE,
      {
        className: 'title',
        lexemes: /[$()>_a-zA-Z0-9]+/,
        keywords: "$ (gdb) hsdb>",
        begin: /^\$ |\(gdb\)|hsdb> /,
        end: /[^\\]\n/,
	contains: [
          hljs.COMMENT('//', '$', { endsParent: true })
	]
      }
    ]
  }
});

hljs.initHighlightingOnLoad(); } },
          { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
          { src: 'reveal.js/plugin/notes/notes.js', async: true }
        ]
      });

      //Reveal.configure({ slideNumber: true });
    </script>

  </body>
</html>

<!--  LocalWords:  HotSpot VM eval defun setq inputStr substring kbd
 -->
<!--  LocalWords:  resultStr concat vhs CDS AppCDS nGrinder OpenJDK
 -->
<!--  LocalWords:  JEP classListParser cpp pre bytecode MemRegion GCs
 -->
<!--  LocalWords:  bool init jint simonis JVMCI bytecodes vm Xshare
 -->
<!--  LocalWords:  DumpSharedSpaces RequireSharedSpaces endif nofast
 -->
<!--  LocalWords:  UseSharedSpaces unshareable CompressedOops ffff fd
 -->
<!--  LocalWords:  SharedBaseAddress TwoLoaders cls args canTryAgain
 -->
<!--  LocalWords:  JNI CreateJavaVM penv bdd bcd InitializeJVM pvm ee
 -->
<!--  LocalWords:  ifn bca JavaMain fffffffa faffd loadClass cp oop
 -->
<!--  LocalWords:  UnlockDiagnosticVMOptions SharedArchiveFile Klass
 -->
<!--  LocalWords:  PrintSharedArchiveAndExit PrintSharedDictionary ik
 -->
<!--  LocalWords:  ClassLoaderData ArrayKlass ModuleEntry const klass
 -->
<!--  LocalWords:  InstanceKlass ClassFileStream GrowableArray jni
 -->
<!--  LocalWords:  SharedDictionaryEntry DefineClass JNIEnv jobject
 -->
<!--  LocalWords:  jbyte jsize jclass NativeInterface jvm impl jdk
 -->
<!--  LocalWords:  JNINativeInterface jstring jbyteArray altough TODO
 -->
<!--  LocalWords:  JNINativeMethod DefineClassWithSource runtime cds
 -->
<!--  LocalWords:  DictionaryEntry shoould strncmp
 -->
